=== API ASSOCIATION - DOCUMENTATION ET PROGRESSION ===

1. STRUCTURE DU PROJET
---------------------
üìÅ Structure des dossiers :
- /controllers : Logique m√©tier
- /middleware : Middlewares personnalis√©s
- /models : Mod√®les de donn√©es
- /routes : Routes de l'API
- /public/uploads : Stockage des fichiers upload√©s

2. MOD√àLES DE DONN√âES
--------------------

a) Mod√®le User (User.js)
------------------------
Champs :
- name (String, required) : Nom de l'utilisateur
- nickname (String, required, unique) : Pseudo unique
- email (String, required, unique) : Email
- password (String, required) : Mot de passe crypt√©
- profilePic (String, default: 'default-profile.png') : Photo de profil
- role (String, enum: ['user', 'admin'], default: 'user') : R√¥le utilisateur
- timestamps : Dates de cr√©ation et modification

b) Mod√®le Post (Post.js)
------------------------
Champs :
- title (String, required, trim) : Titre du post
- content (String, required) : Contenu du post
- image (String, default: null) : Image du post
- author (ObjectId, ref: 'User', required) : Auteur du post
- category (String, enum: ['actualit√©', 'annonce'], default: 'actualit√©') : Cat√©gorie
- timestamps : Dates de cr√©ation et modification

c) Mod√®le Event (Event.js)
-------------------------
Champs :
- title (String, required, trim) : Titre de l'√©v√©nement
- description (String, required) : Description de l'√©v√©nement
- date (Date, required) : Date de l'√©v√©nement
- time (String, required) : Heure de l'√©v√©nement
- location (String, required) : Lieu de l'√©v√©nement
- image (String, default: null) : Image de l'√©v√©nement
- organizer (ObjectId, ref: 'User', required) : Organisateur
- maxParticipants (Number, default: null) : Nombre maximum de participants
- participants ([ObjectId], ref: 'User') : Liste des participants
- status (String, enum: ['√† venir', 'en cours', 'termin√©', 'annul√©']) : √âtat de l'√©v√©nement
- timestamps : Dates de cr√©ation et modification

d) Mod√®le Cotisation (Cotisation.js)
----------------------------------
Champs :
- member (ObjectId, ref: 'User', required) : Membre concern√©
- amount (Number, required, min: 0) : Montant de la cotisation
- paymentDate (Date, required) : Date du paiement
- startPeriod (Date, required) : D√©but de la p√©riode
- endPeriod (Date, required) : Fin de la p√©riode
- paymentMethod (String, enum: ['esp√®ces', 'ch√®que', 'virement', 'carte']) : M√©thode de paiement
- status (String, enum: ['en attente', 'valid√©', 'refus√©']) : √âtat de la cotisation
- receiptNumber (String, unique) : Num√©ro de re√ßu
- notes (String) : Notes √©ventuelles
- timestamps : Dates de cr√©ation et modification

3. ENDPOINTS DE L'API
--------------------

a) Routes Utilisateurs (/api/users)
---------------------------------
- POST / : Cr√©er un utilisateur
- POST /login : Connexion utilisateur
- GET / : Liste des utilisateurs (auth required)
- GET /:id : D√©tails d'un utilisateur (auth required)
- PATCH /:id : Modifier un utilisateur (auth required)
- PATCH /profile-picture/:id : Modifier la photo de profil (auth required)

b) Routes Posts (/api/posts)
---------------------------
- GET / : Liste tous les posts (public)
- GET /:id : D√©tails d'un post (public)
- POST / : Cr√©er un post (auth required)
- PATCH /:id : Modifier un post (auth required, auteur uniquement)
- DELETE /:id : Supprimer un post (auth required, auteur ou admin)

c) Routes √âv√©nements (/api/events)
--------------------------------
- GET / : Liste tous les √©v√©nements (public)
- GET /:id : D√©tails d'un √©v√©nement (public)
- POST / : Cr√©er un √©v√©nement (auth required)
- PATCH /:id : Modifier un √©v√©nement (auth required, organisateur uniquement)
- DELETE /:id : Supprimer un √©v√©nement (auth required, organisateur ou admin)
- POST /:id/join : Rejoindre un √©v√©nement (auth required)
- POST /:id/leave : Quitter un √©v√©nement (auth required)

d) Routes Cotisations (/api/cotisations)
--------------------------------------
- POST / : Cr√©er une cotisation (auth required)
- GET /my-cotisations : Voir ses propres cotisations (auth required)
- GET /check-status : V√©rifier si √† jour de cotisation (auth required)
- GET / : Liste toutes les cotisations (admin only)
- GET /:id : D√©tails d'une cotisation (admin ou membre concern√©)
- PATCH /:id/status : Modifier le statut d'une cotisation (admin only)

4. FONCTIONNALIT√âS IMPL√âMENT√âES
------------------------------
‚úÖ Authentification avec JWT
‚úÖ Upload d'images (profil et posts)
‚úÖ Gestion des r√¥les (user/admin)
‚úÖ CRUD complet pour les utilisateurs
‚úÖ CRUD complet pour les posts
‚úÖ V√©rification des permissions
‚úÖ Stockage des fichiers dans /public/uploads

5. S√âCURIT√â
-----------
- Authentification par JWT
- Hashage des mots de passe avec bcrypt
- V√©rification des permissions pour les op√©rations sensibles
- Validation des donn√©es entrantes
- Filtrage des fichiers upload√©s (images uniquement)

6. PROCHAINES √âTAPES
-------------------
‚úÖ Mod√®le Event (√©v√©nements de l'association)
‚úÖ Mod√®le Cotisation (gestion des cotisations)
üî≤ Am√©lioration du mod√®le Post (likes, commentaires)
üî≤ Gestion des m√©dias multiples
üî≤ Syst√®me de notifications
üî≤ Recherche et filtrage

=== INSTRUCTIONS DE TEST ===

1. Test des routes utilisateurs :
-------------------------------
a) Cr√©ation d'un utilisateur :
POST /api/users
{
  "name": "John Doe",
  "nickname": "johndoe",
  "email": "john@example.com",
  "password": "password123"
}

b) Connexion :
POST /api/users/login
{
  "email": "john@example.com",
  "password": "password123"
}

2. Test des routes posts :
------------------------
a) Cr√©ation d'un post :
POST /api/posts
Headers: Authorization: Bearer <token>
Form-data:
- title: "Titre du post"
- content: "Contenu du post"
- category: "actualit√©"
- image: <fichier>

b) R√©cup√©ration des posts :
GET /api/posts

Note : Ce fichier sera mis √† jour au fur et √† mesure de l'√©volution du projet.

=== GUIDE DE TEST POSTMAN (PAS-√Ä-PAS) ===

Pr√©ambule :
- Base URL locale : http://localhost:3000
- Assurez-vous que le serveur est d√©marr√© et que MongoDB est connect√©.

√âtapes g√©n√©rales :
1) Cr√©er un utilisateur (signup)
   - M√©thode : POST
   - URL : /api/users
   - Body (raw JSON) :
     {
       "name": "Test User",
       "nickname": "testuser",
       "email": "test@example.com",
       "password": "pwd12345"
     }
   - R√©ponse attendue : 201 et objet utilisateur (sans password)

2) Se connecter (login) et r√©cup√©rer le token
   - M√©thode : POST
   - URL : /api/users/login
   - Body (raw JSON) :
     {
       "email": "test@example.com",
       "password": "pwd12345"
     }
   - R√©ponse attendue : 200 { "token": "eyJ..." }
   - Copier le token pour les requ√™tes suivantes (Authorization header)

3) Rendre un utilisateur administrateur (optionnel)
   - Pour tester les routes admin, il faut un user avec role = "admin".
   - M√©thode recommand√©e : mettre √† jour directement dans la DB (MongoDB Compass ou mongo shell) :
     db.users.updateOne({ email: "test@example.com" }, { $set: { role: "admin" } })
   - Alternative (temporaire) : modifier `createUser` pour accepter `role` (d√©conseill√© en prod).

4) Tester un endpoint prot√©g√© (ex : cr√©er un post)
   - M√©thode : POST
   - URL : /api/posts
   - Headers : Authorization: Bearer <TOKEN>
   - Body : form-data
     - title (text)
     - content (text)
     - category (text) ‚Äî "actualit√©" ou "annonce"
     - image (file) ‚Äî facultatif
   - R√©ponse attendue : 201 et objet post cr√©√© (champ image : "/uploads/nomFichier")

5) Tester upload photo de profil (user)
   - M√©thode : PATCH
   - URL : /api/users/profile-picture/:id   (remplacer :id par l'ID de l'utilisateur)
   - Headers : Authorization: Bearer <TOKEN>
   - Body : form-data
     - profilePic (file)
   - R√©ponse attendue : 200 + updatedUser.profilePic

6) Cr√©er / rejoindre un √©v√©nement
   - Cr√©er : POST /api/events (auth required, body form-data, image optionnelle)
   - Rejoindre : POST /api/events/:id/join (auth required)

7) Cr√©er une cotisation (membre)
   - M√©thode : POST
   - URL : /api/cotisations
   - Headers : Authorization: Bearer <TOKEN>
   - Body (raw JSON) :
     {
       "amount": 50,
       "startPeriod": "2025-01-01",
       "endPeriod": "2025-12-31",
       "paymentMethod": "carte",
       "notes": "Cotisation annuelle"
     }
   - R√©ponse attendue : 201 + objet cotisation (receiptNumber auto-g√©n√©r√©)

8) V√©rifier statut cotisation
   - GET /api/cotisations/check-status (auth required)
   - R√©ponse : { isActive: true|false, lastCotisation: {...} }

Bonnes pratiques Postman
- Mettre en place un Environment avec une variable `{{baseUrl}}` = http://localhost:3000 et `{{token}}` pour le token.
- Dans l'onglet Authorization des requ√™tes prot√©g√©es, s√©lectionnez "Bearer Token" et collez `{{token}}`.
- Pour les routes qui uploadent, s√©lectionnez Body -> form-data et choisissez type "File" pour le champ image/profilePic.

D√©pannage rapide
- 401 Invalid token : v√©rifiez le header Authorization (format: `Bearer <token>`).
- 403 Acc√®s refus√© : assurez-vous que l'utilisateur a le r√¥le requis (admin) pour la route.
- 400 Erreur de validation : v√©rifiez le body envoy√© (ex : fields required manquants).

Exemples PowerShell (optionnel) :
-- R√©cup√©rer token (exemple curl via PowerShell) --
curl -Method POST -Uri http://localhost:3000/api/users/login -ContentType 'application/json' -Body '{"email":"test@example.com","password":"pwd12345"}'

-- Note --
Ce guide sera mis √† jour si les endpoints ou la s√©curit√© √©voluent. N'h√©sitez pas √† me demander une collection Postman exportable si vous voulez l'importer directement.

=== GUIDE POSTMAN - FLOWS UTILISATEUR (D√âTAILL√â) ===

Configuration initiale
- Cr√©ez un Environment Postman nomm√© `local` avec ces variables :
  - baseUrl = http://localhost:3000
  - token = (laissez vide pour l'instant)

Bonnes pratiques :
- Dans chaque requ√™te prot√©g√©e, utilisez l'onglet Authorization -> Type: Bearer Token -> Token: {{token}}
- Pour les endpoints qui uploadent, choisissez Body -> form-data et mettez le champ de fichier en type "File".

1) Inscription (signup)
- M√©thode : POST
- URL : {{baseUrl}}/api/users
- Body (raw JSON)
  {
    "name": "Test User",
    "nickname": "testuser",
    "email": "test@example.com",
    "password": "pwd12345"
  }
- R√©ponse attendue : 201 et l'objet utilisateur cr√©√©.
  Remarque : la version actuelle du contr√¥leur renvoie l'utilisateur complet (avec le champ `password` hach√©). En production, il vaut mieux filtrer ce champ.

2) Connexion (login)
- M√©thode : POST
- URL : {{baseUrl}}/api/users/login
- Body (raw JSON)
  {
    "email": "test@example.com",
    "password": "pwd12345"
  }
- R√©ponse attendue : 200
  Exemple : { "token": "eyJhbGciOiJI..." }
- Action Postman : copiez la valeur `token` et collez-la dans la variable d'environnement `{{token}}` (ou utilisez un script Tests pour l'enregistrer automatiquement).

Exemple de script Tests pour stocker le token automatiquement :
```javascript
const res = pm.response.json();
if (res.token) {
  pm.environment.set('token', res.token);
}
```

3) R√©cup√©rer son profil / D√©tails utilisateur
- M√©thode : GET
- URL : {{baseUrl}}/api/users/:id  (remplacez :id par l'ID renvoy√© √† la cr√©ation)
- Headers : Authorization: Bearer {{token}}
- R√©ponse attendue : 200 + objet utilisateur (sans password si controller filtre)

4) Mettre √† jour son profil
- M√©thode : PATCH
- URL : {{baseUrl}}/api/users/:id
- Headers : Authorization: Bearer {{token}}
- Body (raw JSON) ‚Äî exemples de champs accept√©s :
  {
    "name": "Nom modifi√©",
    "nickname": "nouveaunick",
    "email": "nouveau@example.com",
    "password": "newpassword"   // sera hach√© automatiquement
  }
- R√©ponse attendue : 200 + utilisateur mis √† jour (le mot de passe est hach√© en base)

5) Upload / modifier la photo de profil
- M√©thode : PATCH
- URL : {{baseUrl}}/api/users/profile-picture/:id
- Headers : Authorization: Bearer {{token}}
- Body : form-data
  - Key : profilePic (type File) -> s√©lectionnez une image
- R√©ponse attendue : 200 + { data: { profilePic: '/uploads/nomFichier' } }

6) Lister les utilisateurs
- M√©thode : GET
- URL : {{baseUrl}}/api/users
- Headers : Authorization: Bearer {{token}}
- R√©ponse attendue : 200 + tableau d'utilisateurs
  Remarque : actuellement la route est prot√©g√©e par `verifyToken` mais n'exige pas explicitement le r√¥le admin; selon vos r√®gles m√©tier vous pouvez la restreindre avec `isAdmin`.

7) Supprimer un utilisateur
- M√©thode : DELETE
- URL : {{baseUrl}}/api/users/:id
- Headers : Authorization: Bearer {{token}}
- R√©ponse attendue : 200 + { message: 'User deleted successfully' }
  Remarque : la logique actuelle permet √† un utilisateur authentifi√© d'appeler la suppression ; si vous voulez limiter cette action (ex : admin uniquement), il faudra ajouter `isAdmin` ou une v√©rification dans `deleteUser`.

8) G√©rer les r√¥les (dev / admin)
- Pour rendre un utilisateur admin rapidement, utilisez MongoDB Compass ou mongo shell :
  db.users.updateOne({ email: "test@example.com" }, { $set: { role: "admin" } })
- Apr√®s modification, reconnectez-vous (login) pour obtenir un token avec le role mis √† jour.

9) Cas d'erreurs fr√©quentes
- 401 No token provided / Invalid token : v√©rifiez que le header Authorization est pr√©sent et au format `Bearer <token>`.
- 403 Acc√®s r√©serv√© aux administrateurs : l'utilisateur n'a pas le r√¥le attendu.
- 400 Erreur de validation : champs requis manquants ou format incorrect.

10) Commandes curl utiles (PowerShell)
- Login (r√©cup√©rer token) :
  curl -Method POST -Uri http://localhost:3000/api/users/login -ContentType 'application/json' -Body '{"email":"test@example.com","password":"pwd12345"}'

- Upload fichier (profilePic) via curl :
  curl -Method PATCH -Uri http://localhost:3000/api/users/profile-picture/<ID> -Headers @{"Authorization"="Bearer <TOKEN>"} -Form @{profilePic="@C:\path\to\image.jpg"}

11) Export Postman
- Si vous souhaitez, je peux g√©n√©rer une collection Postman (JSON) avec toutes les requ√™tes ci‚Äëdessus pour que vous l'importiez directement.

Fin du guide utilisateur d√©taill√©.